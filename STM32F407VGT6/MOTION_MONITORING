//IoT-Based Motion Monitoring System using STM32F407
#include <stdint.h>

#include <stdio.h>

#define RCC_AHB1ENR   (*(volatile uint32_t*)0x40023830)
#define RCC_APB1ENR   (*(volatile uint32_t*)0x40023840)
#define USART2_SR     (*(volatile unsigned int* )0x40004400)
#define USART2_DR     (*(volatile unsigned int*) 0x40004404)
#define USART2_BRR    (*(volatile unsigned int*) 0x40004408)
#define USART2_CR1    (*(volatile unsigned int*) 0x4000440C)
#define USART2_CR2    (*(volatile unsigned int*) 0x40004410)



#define GPIOB_MODER   (*(volatile uint32_t*) 0x40020400)
#define GPIOA_MODER (*(volatile unsigned int*)0x40020000)
#define GPIOA_AFRL (*(volatile unsigned int *) 0x40020020)

#define GPIOA_IDR     (*(volatile uint32_t*) 0x40020010)
#define GPIOB_OTYPER  (*(volatile uint32_t*) 0x40020404)
#define GPIOB_OSPEEDR (*(volatile uint32_t*) 0x40020408)
#define GPIOB_PUPDR   (*(volatile uint32_t*) 0x4002040C)
#define GPIOB_AFRL    (*(volatile uint32_t*) 0x40020420)
#define GPIOB_AFRH    (*(volatile uint32_t*) 0x40020424)



#define I2C1_CR1      (*(volatile uint32_t*)0x40005400)
#define I2C1_CR2      (*(volatile uint32_t*)0x40005404)
#define I2C1_OAR1     (*(volatile uint32_t*)0x40005408)
#define I2C1_DR       (*(volatile uint32_t*)0x40005410)
#define I2C1_SR1      (*(volatile uint32_t*)0x40005414)
#define I2C1_SR2      (*(volatile uint32_t*)0x40005418)
#define I2C1_CCR      (*(volatile uint32_t*)0x4000541C)
#define I2C1_TRISE    (*(volatile uint32_t*)0x40005420)


#define ADXL345_ADDR  (0x53 << 1)


int16_t x, y, z;
uint8_t data[6];
char buffer[100];



void delay(void)
{
    for(int i=0;i<500000;i++);
}


void I2C1_Init(void)
{
    RCC_AHB1ENR |= (1<<1);
    RCC_APB1ENR |= (1<<21);

    GPIOB_MODER |= (2<<16) | (2<<18);
    GPIOB_AFRH |= (4<<0) | (4<<4);
    GPIOB_OTYPER |= (1<<8) | (1<<9);
    GPIOB_OSPEEDR |= (3<<16) | (3<<18);
    GPIOB_PUPDR |= (1<<16) | (1<<18);

    I2C1_CR2 = 16;
    I2C1_CCR = 80;
    I2C1_TRISE = 17;
    I2C1_CR1 |= (1<<0);
}


void I2C_Write(uint8_t reg, uint8_t data)
{
    I2C1_CR1 |= (1<<8);
    while(!(I2C1_SR1 & (1<<0)));

    I2C1_DR = ADXL345_ADDR;
    while(!(I2C1_SR1 & (1<<1)));
    (void)I2C1_SR2;

    while(!(I2C1_SR1 & (1<<7)));
    I2C1_DR = reg;

    while(!(I2C1_SR1 & (1<<7)));
    I2C1_DR = data;

    while(!(I2C1_SR1 & (1<<2)));
    I2C1_CR1 |= (1<<9);
}

void I2C_ReadMulti(uint8_t reg, uint8_t *buffer, uint8_t length)
{
    uint8_t i;


    while(I2C1_SR2 & (1<<1));

    // star
    I2C1_CR1 |= (1<<8);
    while(!(I2C1_SR1 & (1<<0)));

    //  slave address  Write
    I2C1_DR = ADXL345_ADDR;
    while(!(I2C1_SR1 & (1<<1)));  // add set
    (void)I2C1_SR2;               // clear add

    // Send register address txe
    while(!(I2C1_SR1 & (1<<7)));
    I2C1_DR = reg;
//wait txe
    while(!(I2C1_SR1 & (1<<7)));

    // generate restart
    I2C1_CR1 |= (1<<8);
    while(!(I2C1_SR1 & (1<<0)));  // sb

    // send slave address Read
    I2C1_DR = ADXL345_ADDR | 0x01;
    while(!(I2C1_SR1 & (1<<1)));  // addr set
    (void)I2C1_SR2;

    // enable ack
    I2C1_CR1 |= (1<<10);

    for(i = 0; i < length; i++)
    {
        if(i == length-1)
        {
            // disable ack for last byte
            I2C1_CR1 &= ~(1<<10);
            I2C1_CR1 |= (1<<9);   // stop
        }

        while(!(I2C1_SR1 & (1<<6)));  // rxne
        buffer[i] = I2C1_DR;
    }
}


void ADXL345_Init(void)
{
    I2C_Write(0x2D, 0x08);
    I2C_Write(0x31, 0x0B);
}

void ADXL345_ReadXYZ(int16_t *x, int16_t *y, int16_t *z)
{
    uint8_t buffer[6];

    I2C_ReadMulti(0x32, buffer, 6);

    *x = (int16_t)((buffer[1] << 8) | buffer[0]);
    
    *y = (int16_t)((buffer[3] << 8) | buffer[2]);
    
    *z = (int16_t)((buffer[5] << 8) | buffer[4]);
}



void UART2_Init(void)
{
    RCC_AHB1ENR |= (1<<0);
    RCC_APB1ENR |= (1<<17);



    GPIOA_MODER &= ~(3 <<4);
        GPIOA_MODER |=  (2 <<4);

        GPIOA_AFRL &= ~(0xF << 8);
          GPIOA_AFRL |=  (7 << 8);

    USART2_BRR = 0x0683;
    USART2_CR1 |= (1<<3) ;
		USART2_CR1 |=(1<<13);
}



void UART2_WriteString(char *str)
{
    while(*str)
    {
    	 while(!(USART2_SR & (1<<7)));
    	    USART2_DR = *str++;

    }

}

int main(void)
{
    int16_t x, y, z;
    char buffer[64];

    UART2_Init();
    I2C1_Init();
    ADXL345_Init();



while(1){
        ADXL345_ReadXYZ(&x, &y, &z);


        sprintf(buffer, "X:%d Y:%d Z:%d \r\n", x,y,z);

        UART2_WriteString(buffer);
        delay();

}
}
